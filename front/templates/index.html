<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="{{url_for('static', filename='img/logos/icon.png')}}">

    <title>ALeRCE SNe Hunter</title>

    <!-- Bootstrap core CSS -->
    <link href="{{url_for('static',filename='vendor/bootstrap/css/bootstrap.min.css')}}" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css"> -->
    <link href="{{url_for('static',filename='vendor/d3-celestial/celestial.css')}}" rel="stylesheet">

    <style media="screen">
      .auto-adjust{
        margin-top: auto;
        margin-bottom: auto;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">
        <img src="{{url_for('static',filename='img/logos/footerAlerce.png')}}" width="30" height="30" class="d-inline-block align-top" alt="">
        ALeRCE SNe Hunter
      </a>
    </nav>

    <div class="container-fluid" >
      <!-- Image and text -->

      <!-- <div class="col-sm-3 offset-sm-5" id="loading" style="padding-top: 10%;">
        <div class="spinner-border " role="status">
          <span class="sr-only">Loading...</span>
        </div> <span style=" font-weight: bold; font-size:30px;">Loading...</span>
      </div> -->

      <!-- <div id="results"  class="d-none"> -->
      <div id="results">
          <div class="row">
            <div class="col-md-12">
              <h5 class="text-center">Top 100 SNe Candidates</h5> <hr style="margin:0 0 0 0">
              <p class="text-center">Click row for more information. </p>
            </div>
          </div>
          <div class="row">
            <div class="auto-adjust col-md-7">
              <div style="overflow:hidden;">
                <div style="overflow:hidden;">
                  <div id="celestial-map">
                  </div>
                </div>
                <div id="celestial-form"></div>
                <p class="text-center">Smaller circles means lower probability</p>
              </div>

            </div> <!-- col-md-8-->
            <div class="col-md-5">
              <div class="row">
                <div class="col-md-6">
                  <select id="timePicker" class="browser-default custom-select">
                    <option selected value="2">Last 48 Hours</option>
                    <option value="3">Last 72 Hours</option>
                    <option value="7">Last Week</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control" placeholder="Search" id="searchDataTable">
                </div>
              </div>
              <table id="sneCandidates" class="table table-hover table-bordered" style="height:100%">
                <thead>
                  <tr>
                      <th>ObjectID</th>
                      <th>RA</th>
                      <th>Dec</th>
                      <th>Prob</th>
                      <th></th>
                  </tr>
              </thead>
              <tbody>
              </tbody>
              </table>
            </div> <!-- col-md-4-->
          </div>
      </div>
    </div> <!-- /container -->
    <!-- Footer -->
    <footer class="page-footer font-small blue">


    </footer>
    <!-- Footer -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="{{url_for('static',filename='vendor/jquery/js/jquery-3.4.1.min.js')}}"><\/script>')</script>
    <script src="{{url_for('static',filename='vendor/bootstrap/js/bootstrap.min.js')}}"></script>
    <script type="text/javascript" src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <!-- <script src="{{url_for('static',filename='vendor/d3-celestial/lib/d3.min.js')}}"></script>
    <script src="{{url_for('static',filename='vendor/d3-celestial/lib/d3.geo.projection.min.js')}}"></script>
    <script src="{{url_for('static',filename='vendor/d3-celestial/celestial.js')}}"></script> -->
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script type="text/javascript" src="https://ofrohn.github.io/celestial.min.js"></script>

    <script type="text/javascript">

                var config = {
                   datapath: "{{url_for('static',filename='vendor/d3-celestial/data')}}",
                   planets:  { show: false },
                   stars: {show: false},
                   dsos: {show:false, limit:30},
                   constellations: {show:false},
                   transform: "equatorial",
                   background:{
                    fill: "#8778d2",
                    opacity:1
                    },
                   mw:{
                     show:true,
                     style:{
                       fill: "#ffffff",
                       opacity: 0.3
                     }
                   },
                    lines:{
                        graticule: { show: true, stroke: "#cccccc", width: 0.6, opacity: 0.8,      // Show graticule lines
                          // grid values: "outline", "center", or [lat,...] specific position
                          lon: {pos: ["center"], fill: "#eee", font: "10px Helvetica, Arial, sans-serif"},
                          // grid values: "outline", "center", or [lon,...] specific position
                          lat: {pos: ["center"], fill: "#eee", font: "10px Helvetica, Arial, sans-serif"}},
                    }

                }

    Date.prototype.subsDays = function(days) {
      var date = new Date(this.valueOf());
      date.setDate(date.getDate() - days);
      return date;
    }
    function dateToJD(date) {
        var mjulianDate = date / 86400000 + 40588;
        return mjulianDate;
    }

    function renderData(){
      var points = new Array();
      var table = $("#sneCandidates").DataTable();
      var data_table = table.data();
      if (data_table.length == 0){
        Celestial.clear();
        Celestial.display(config);
      }else{
        Celestial.clear();

        $.each(data_table,function(index,value){
          var oid = value[0], prob=value[3], ra=value[5], dec=value[6];

          points.push({
             "type":"Feature",
             "id":oid,
             "properties": {
               // Name
               "name":oid,
               "type":"sn",
               // magnitude, dimension in arcseconds or any other size criterion
               //"mag": 10,
               //"dim": 30
               "prob": prob
             }, "geometry":{
               // the location of the object as a [ra, dec] array in degrees [-180..180, -90..90]
               "type":"Point",
               "coordinates": [ra,dec]
             }
           });

        });

        var jsonSN = {
          "type":"FeatureCollection",
          // this is an array, add as many objects as you want
          "features": points
          };

        var pointStyle = {
              stroke: "#f0f",
              width: 3,
              fill: "rgba(255, 204, 255, 0.8)"
            };
        var textStyle = {
              font: "bold 15px Helvetica, Arial, sans-serif",
              align: "left",
              baseline: "bottom"
            };


            Celestial.add({type:"raw",
                          callback: function(error, json) {
                            if (error) return console.warn(error);
                            // Load the geoJSON file and transform to correct coordinate system, if necessary
                            var dsn = Celestial.getData(jsonSN, config.transform);

                            // Add to celestial objects container in d3
                            Celestial.container.selectAll(".sn")
                              .data(dsn.features)
                              .enter().append("path")
                              .attr("class", "sn");
                            // Trigger redraw to display changes
                            Celestial.redraw();
                          },
                          redraw: function() {
                              // Select the added objects by class name as given previously
                              Celestial.container.selectAll(".sn").each(function(d) {
                                // If point is visible (this doesn't work automatically for points)
                                if (Celestial.clip(d.geometry.coordinates)) {
                                  // get point coordinates
                                  var pt = Celestial.mapProjection(d.geometry.coordinates);
                                  // object radius in pixel, could be varable depending on e.g. dimension or magnitude
                                  var r = 5*Math.pow(d.properties.prob,32); // replace 20 with dimmest magnitude in the data

                                  // draw on canvas
                                  //  Set object styles fill color, line color & width etc.
                                  Celestial.setStyle(pointStyle);
                                  // Start the drawing path
                                  Celestial.context.beginPath();
                                  // Thats a circle in html5 canvas
                                  Celestial.context.arc(pt[0], pt[1], r, 0, 2 * Math.PI);
                                  // Finish the drawing path
                                  Celestial.context.closePath();
                                  // Draw a line along the path with the prevoiusly set stroke color and line width
                                  Celestial.context.stroke();
                                  // Fill the object path with the prevoiusly set fill color
                                  Celestial.context.fill();

                                  // Set text styles
                                  Celestial.setTextStyle(textStyle);
                                  // and draw text on canvas
                                  Celestial.context.fillText(d.properties.name, pt[0] + r - 1, pt[1] - r + 1);
                                }
                              });
                            }
                          });
        Celestial.display(config);
      }
    }

    $(document).ready( function () {
            var date = new Date($.now());
            var delta = 2;
            $('#sneCandidates').DataTable({
              "pageLength": 6,
              "dom":"t,p,r",
              "order": [[ 3, "desc" ]],
              "responsive": true,
              "searching": true, "info": false,"lengthChange":false,
              'processing': true,
              'language': {
                  'loadingRecords': '&nbsp;',
                  'processing': 'Loading...'
              },
              "ajax": {
                "url": "http://ztf.alerce.online/query",
                "contentType": "application/json",
                "type": "POST",
                "columnDefs": [
                  {
                    "targets": [ 4,5],
                    "visible": false,
                    "searchable": false
                  }],
                  "data": function(d){
                    var rawData = new Object();
                    var now_mjd = dateToJD(date);
                    var last_mjd = dateToJD(date.subsDays(delta));

                    return JSON.stringify(
                      {"records_per_pages":100,
                      "query_parameters":
                      {"filters":
                      {"classearly": 2},
                      "dates":
                      {"firstmjd":
                      {"min":last_mjd,"max":now_mjd}
                    }},
                    "sortBy": "pclassearly",
                    "total":100
                  })
                },
                "dataSrc": function(json){
                  var data = new Array();

                  $.each(json["result"],function(key,value){
                    url_object = '<a href="http://alerce.xyz/vue/object/'+key+'" target="_blank">More</a>'
                    ra =value["meanra"].toFixed(3);
                    dec =value["meandec"].toFixed(3);
                    prob = value["pclassearly"].toFixed(3);

                    data.push([key,ra,dec,prob,url_object,value["meanra"],value["meandec"]]);
                  });
                  return data
                }
              },
              "initComplete": function(settings, json) {
                renderData();
              }
            });

            Celestial.display(config);


            var zoomed = false;
            $("table tbody").on({
              click: function () {
                $(".table-active").removeClass("table-active")
                $(this).attr("class","table-active")
                var anim = Array();
                var data = $("#sneCandidates").DataTable().row(this).data();
                var ra = data[5],
                    dec = data[6],
                    oid = data[0]
                var pt = [ra,dec,0];//Celestial.mapProjection([ra,dec]);

                if(zoomed){
                  anim.push({param:"zoom", value:0.8, duration:1});
                }
                anim.push({param:"center", value:pt, duration:2500});
                anim.push({param:"zoom", value:5, duration:1});

                Celestial.animate(anim, false);

              }
            },'tr');

            $("#timePicker").on("change", function(){
              var days = $( "#timePicker option:selected" ).val();
              delta = days;

              $("#sneCandidates").DataTable().ajax.reload(function(){
                renderData();
              });
            });
            $('#searchDataTable').keyup(function(){
                  $("#sneCandidates").DataTable().search($(this).val()).draw() ;
            })
        });

    </script>

  </body>
</html>
